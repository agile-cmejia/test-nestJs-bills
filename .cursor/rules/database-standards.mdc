---
description: Database entity management - ALL entities managed by AvantoDB only
globs: 
alwaysApply: true
---

# Database Standards

## ⚠️ CRITICAL: Entity Management Policy

**ALL database entities, schemas, and migrations are managed EXCLUSIVELY by `@avantodev/avanto-db`.**

This repository:
- ✅ **ONLY** updates the `@avantodev/avanto-db` dependency version
- ✅ **ONLY** imports and uses entities from `@avantodev/avanto-db`
- ❌ **NEVER** creates local entities (`@Entity` decorator)
- ❌ **NEVER** runs migrations
- ❌ **NEVER** modifies database schemas directly

## Prohibited Actions

```typescript
// ❌ FORBIDDEN: Creating entities in this repository
@Entity('my_table')
export class MyEntity {
  // This is NOT allowed
}

// ❌ FORBIDDEN: Creating migrations
export class CreateMyTable1234567890 implements MigrationInterface {
  // This is NOT allowed
}
```

## Correct Usage

```typescript
// ✅ CORRECT: Import entities from avanto-db
import { Tenant, User, RecordHeader } from '@avantodev/avanto-db';

@Module({
  imports: [
    TypeOrmModule.forFeature([Tenant, User, RecordHeader]),
  ],
})
export class YourModule {}
```

## When Database Changes Are Needed

If you need to add or modify database entities/schemas:

### Step 1: Export Requirements Document

When the AI detects a database change requirement, it MUST:

1. Create a markdown file in `docs/database-requests/` with the specification
2. Inform the user they need to implement changes in AvantoDB repository
3. **NEVER** attempt to create entities or run migrations locally

### Step 2: Document Format

The exported document should follow this template:

```markdown
# Database Change Request

## Date: YYYY-MM-DD
## Requested By: [Feature/Ticket Name]

## New Entity Required

### Entity Name: `YourEntityName`

### Table Name: `your_table_name`

### Columns:
| Column | Type | Nullable | Default | Description |
|--------|------|----------|---------|-------------|
| id | uuid | NO | uuid_generate_v4() | Primary key |
| name | varchar(255) | NO | - | Entity name |
| created_at | timestamp | NO | CURRENT_TIMESTAMP | Creation date |

### Indexes:
- `IDX_YOUR_TABLE_NAME` on `column_name` (unique: yes/no)

### Relations:
- `ManyToOne` to `Tenant` via `tenant_id`
- `OneToMany` to `OtherEntity` via `your_entity_id`

### Constraints:
- `NOT NULL` on required fields
- `FOREIGN KEY` to related tables

## Migration Notes:
- [Any special considerations for the migration]
```

### Step 3: User Action Required

After exporting the document, tell the user:

> **⚠️ Database Change Required**
> 
> I've exported the database requirements to `docs/database-requests/[filename].md`.
> 
> **Next steps:**
> 1. Go to the `avanto-db` repository
> 2. Create the entity following the specification
> 3. Run migrations in avanto-db
> 4. Publish a new version of `@avantodev/avanto-db`
> 5. Return here and update the dependency: `yarn upgrade @avantodev/avanto-db@latest`

## Updating AvantoDB Dependency

When a new version of avanto-db is available:

```bash
# Update to latest version
yarn upgrade @avantodev/avanto-db@latest

# Or update to specific version
yarn upgrade @avantodev/avanto-db@1.3.49
```

Then register the new entity in `EntitiesModule`:

```typescript
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { Tenant, NewEntity } from '@avantodev/avanto-db';

@Module({
  imports: [
    TypeOrmModule.forFeature([Tenant, NewEntity]),
  ],
})
export class EntitiesModule {}
```

## Query Optimization (Read-Only Patterns)

Since we only read from the database schema:

```typescript
// ✅ CORRECT: Use repository methods
const entity = await this.repository.findOne({
  where: { id },
  relations: ['tenant', 'createdBy'],
});

// ✅ CORRECT: Use query builder for complex queries
const results = await this.repository
  .createQueryBuilder('entity')
  .leftJoinAndSelect('entity.tenant', 'tenant')
  .where('entity.isActive = :isActive', { isActive: true })
  .getMany();

// ✅ CORRECT: Use transactions for multi-step reads
await this.manager.transaction(async (transactionalEntityManager) => {
  const entity = await transactionalEntityManager.findOne(Entity, { where: { id } });
  // Process entity
});
```

## Anti-Patterns (PROHIBITED)

1. ❌ **NEVER** create `@Entity()` decorated classes in this repository
2. ❌ **NEVER** create migration files
3. ❌ **NEVER** run `yarn migration:generate` or `yarn migration:create`
4. ❌ **NEVER** run `yarn typeorm migration:run`
5. ❌ **NEVER** modify database schemas directly via raw SQL
6. ❌ **NEVER** use `synchronize: true` in production
7. ❌ **NEVER** create TypeORM subscribers that modify schema

## Checklist Before Any Database-Related Work

- [ ] Is the entity already available in `@avantodev/avanto-db`?
- [ ] If not, have I exported the requirements document?
- [ ] Have I informed the user to modify avanto-db?
- [ ] Am I only using imported entities, never creating new ones?
- [ ] Am I only reading/writing data, never modifying schema?
